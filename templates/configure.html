<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration Frenchio</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6b5ce7;
            --primary-hover: #5541d9;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --text: #2d3436;
            --text-muted: #636e72;
            --border: #dfe6e9;
            --danger: #ff7675;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 40px 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--primary);
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }

        .card-header {
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 15px;
        }

        h2 {
            margin: 0;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .badge {
            background: #e0e0e0;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #555;
            font-weight: normal;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
        }

        .help-text {
            display: block;
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 5px;
        }

        input[type="text"], input[type="url"], input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }

        input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .tracker-item {
            background: #fdfdfd;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            width: 100%;
            font-size: 1.1rem;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
            width: 100%;
        }

        .btn-outline:hover {
            background: rgba(107, 92, 231, 0.05);
        }

        .btn-remove {
            position: absolute;
            top: 15px;
            right: 15px;
            background: transparent;
            color: var(--danger);
            border: none;
            cursor: pointer;
            padding: 5px;
            font-size: 1.2rem;
        }

        .btn-remove:hover {
            opacity: 0.7;
        }

        #installLink {
            display: none;
            margin-top: 30px;
            background: #dff9fb;
            border: 2px solid #b2bec3;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .install-btn {
            display: inline-block;
            background: #00cec9;
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: bold;
            font-size: 1.2rem;
            margin: 15px 0;
            box-shadow: 0 4px 15px rgba(0, 206, 201, 0.3);
        }

        .install-btn:hover {
            transform: scale(1.05);
        }

        .info-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(102, 126, 234, 0.2);
            text-align: center;
        }

        .info-box a {
            color: white;
            text-decoration: underline;
        }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üá´üá∑ Frenchio</h1>
            <div class="subtitle">Streamer depuis UNIT3D, Sharewood & YGG via AllDebrid, TorBox ou qBittorrent</div>
        </header>
        
        <!-- Blurb personnalis√© (cach√© par d√©faut) -->
        <div id="customBlurb" class="info-box" style="display: none;"></div>
        
        <!-- Services Obligatoires -->
        <div class="card">
            <div class="card-header">
                <h2>üîë Services Requis</h2>
            </div>
            
            <div class="form-group">
                <label for="tmdbKey">Cl√© API TMDB (v3)</label>
                <input type="text" id="tmdbKey" placeholder="Ex: a1b2c3d4...">
                <span class="help-text">N√©cessaire pour r√©cup√©rer les titres corrects. <a href="https://www.themoviedb.org/settings/api" target="_blank">Obtenir ma cl√©</a></span>
            </div>

            <div class="form-group">
                <label>Service de d√©bridage <span class="badge">Optionnel</span></label>
                <div style="margin-bottom: 15px;">
                    <label id="debridNoneLabel" style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;">
                        <input type="radio" name="debridService" value="none" id="debridNone" checked>
                        <span>Aucun (qBittorrent seulement)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;">
                        <input type="radio" name="debridService" value="alldebrid" id="debridAlldebrid">
                        <span>AllDebrid</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                        <input type="radio" name="debridService" value="torbox" id="debridTorbox">
                        <span>TorBox</span>
                    </label>
                </div>
            </div>

            <div class="form-group" id="alldebridKeyGroup" style="display: none;">
                <label for="alldebridKey">Cl√© API AllDebrid</label>
                <input type="text" id="alldebridKey" placeholder="Ex: xYz123...">
                <span class="help-text">Pour v√©rifier le cache et d√©brider les liens. <a href="https://alldebrid.com/apikeys" target="_blank">Obtenir ma cl√©</a></span>
            </div>

            <div class="form-group" id="torboxKeyGroup" style="display: none;">
                <label for="torboxKey">Cl√© API TorBox</label>
                <input type="text" id="torboxKey" placeholder="Ex: abc123...">
                <span class="help-text">Alternative √† AllDebrid. <a href="https://torbox.app/settings" target="_blank">Obtenir ma cl√©</a></span>
            </div>
        </div>

        <!-- Optionnel: qBittorrent -->
        <div class="card" id="qbittorrentSection">
            <div class="card-header">
                <h2>üì• Client Torrent (qBittorrent) <span class="badge">Optionnel</span></h2>
            </div>
            <p class="help-text">
                Alternative √† AllDebrid : t√©l√©chargez directement sur votre serveur/NAS.
                N√©cessite un serveur Web (Nginx/Apache) qui expose le dossier de t√©l√©chargement.
            </p>
            
            <div class="form-group">
                <label for="qbitUrl">URL qBittorrent (WebUI)</label>
                <input type="url" id="qbitUrl" placeholder="http://192.168.1.50:8080">
            </div>
            
            <div style="display: flex; gap: 15px;">
                <div class="form-group" style="flex: 1;">
                    <label for="qbitUser">Utilisateur</label>
                    <input type="text" id="qbitUser" placeholder="admin">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="qbitPass">Mot de passe</label>
                    <input type="password" id="qbitPass">
                </div>
            </div>

            <div class="form-group">
                <label for="qbitPublicUrl">URL Publique des Fichiers</label>
                <input type="url" id="qbitPublicUrl" placeholder="http://monserveur.com/downloads">
                <span class="help-text">L'adresse HTTP o√π Stremio pourra lire les fichiers t√©l√©charg√©s.</span>
            </div>
        </div>

        <!-- Trackers Semi-Priv√©s/Publics -->
        <div class="card">
            <div class="card-header">
                <h2>üåê Trackers Publics / Semi-Priv√©s <span class="badge">Optionnel</span></h2>
            </div>

            <div class="form-group">
                <label for="sharewoodPasskey">Passkey Sharewood</label>
                <input type="text" id="sharewoodPasskey" placeholder="32 caract√®res">
                <span class="help-text">Trouvable dans vos param√®tres Sharewood.</span>
            </div>

            <div class="form-group">
                <label for="yggPasskey">Passkey YGG</label>
                <input type="text" id="yggPasskey" placeholder="32 caract√®res">
                <span class="help-text">Trouvable dans votre profil YGG.</span>
            </div>
        </div>

        <!-- Trackers UNIT3D -->
        <div class="card">
            <div class="card-header">
                <h2>üîí Trackers UNIT3D (Priv√©s) <span class="badge">Recommand√©</span></h2>
            </div>
            
            <p class="help-text" style="margin-bottom: 20px;">
                Ajoutez ici vos trackers bas√©s sur le moteur UNIT3D. UNIT3D est une plateforme de tracker BitTorrent utilis√©e par de nombreux trackers priv√©s fran√ßais.
                L'URL doit √™tre la racine du site (https://site.com). Le token API se g√©n√®re dans vos param√®tres de profil sur le site.
            </p>

            <div id="trackersContainer">
                <!-- Les trackers seront ajout√©s ici -->
            </div>
            
            <button type="button" class="btn btn-outline" onclick="addTracker()">+ Ajouter un Tracker UNIT3D</button>
        </div>
        
        <div style="text-align: center; margin-top: 40px;">
            <button type="button" class="btn btn-primary" onclick="generateLink()">üöÄ G√©n√©rer et Installer</button>
        </div>

        <div id="installLink">
            <h3>Configuration pr√™te !</h3>
            <a href="#" id="stremioLink" class="install-btn">Installer sur Stremio</a>
            <div id="extraLinks"></div>
        </div>
    </div>

    <script>
        // Placeholders remplac√©s par le serveur
        const prefillConfig = {};
        const qbittorrentEnabled = true;
        const manifestBlurb = "";

        function addTracker(data = null) {
            const container = document.getElementById('trackersContainer');
            const div = document.createElement('div');
            div.className = 'tracker-item';
            div.innerHTML = `
                <button type="button" class="btn-remove" onclick="this.parentElement.remove()" title="Supprimer">√ó</button>
                <div class="form-group">
                    <label>URL du Tracker</label>
                    <input type="url" class="tracker-url" placeholder="https://votre-tracker-unit3d.com" value="${data ? data.url : ''}">
                </div>
                <div class="form-group">
                    <label>Token API</label>
                    <input type="text" class="tracker-token" placeholder="Votre API Token personnel" value="${data ? data.token : ''}">
                </div>
            `;
            container.appendChild(div);
        }

        // Gestion des radio buttons pour le service de d√©bridage
        function updateDebridFields() {
            const selectedService = document.querySelector('input[name="debridService"]:checked').value;
            
            document.getElementById('alldebridKeyGroup').style.display = 
                selectedService === 'alldebrid' ? 'block' : 'none';
            document.getElementById('torboxKeyGroup').style.display = 
                selectedService === 'torbox' ? 'block' : 'none';
        }
        
        document.querySelectorAll('input[name="debridService"]').forEach(radio => {
            radio.addEventListener('change', updateDebridFields);
        });

        // Chargement initial
        if (prefillConfig && Object.keys(prefillConfig).length > 0) {
            document.getElementById('tmdbKey').value = prefillConfig.tmdb_key || '';
            
            // D√©tecter quel service est configur√©
            if (prefillConfig.alldebrid_key && prefillConfig.alldebrid_key.trim()) {
                document.getElementById('debridAlldebrid').checked = true;
                document.getElementById('alldebridKey').value = prefillConfig.alldebrid_key;
            } else if (prefillConfig.torbox_key && prefillConfig.torbox_key.trim()) {
                document.getElementById('debridTorbox').checked = true;
                document.getElementById('torboxKey').value = prefillConfig.torbox_key;
            } else {
                document.getElementById('debridNone').checked = true;
            }
            
            updateDebridFields();
            
            // qBit
            if (prefillConfig.qbittorrent) {
                document.getElementById('qbitUrl').value = prefillConfig.qbittorrent.host || '';
                document.getElementById('qbitUser').value = prefillConfig.qbittorrent.username || '';
                document.getElementById('qbitPass').value = prefillConfig.qbittorrent.password || '';
                document.getElementById('qbitPublicUrl').value = prefillConfig.qbittorrent.public_url || '';
            }

            document.getElementById('sharewoodPasskey').value = prefillConfig.sharewood_passkey || '';
            document.getElementById('yggPasskey').value = prefillConfig.ygg_passkey || '';
            
            if (prefillConfig.trackers && prefillConfig.trackers.length > 0) {
                prefillConfig.trackers.forEach(t => addTracker(t));
            } else {
                addTracker();
            }
        } else {
            addTracker();
        }
        
        // Masquer la section qBittorrent si d√©sactiv√©e c√¥t√© serveur
        if (!qbittorrentEnabled) {
            const qbitSection = document.getElementById('qbittorrentSection');
            if (qbitSection) {
                qbitSection.style.display = 'none';
            }
            
            // Masquer l'option "Aucun (qBittorrent seulement)"
            const debridNoneLabel = document.getElementById('debridNoneLabel');
            if (debridNoneLabel) {
                debridNoneLabel.style.display = 'none';
            }
            
            // Si "Aucun" √©tait s√©lectionn√©, s√©lectionner AllDebrid par d√©faut
            const debridNone = document.getElementById('debridNone');
            if (debridNone && debridNone.checked) {
                document.getElementById('debridAlldebrid').checked = true;
                updateDebridFields();
            }
        }
        
        // Afficher le blurb personnalis√© si configur√©
        if (manifestBlurb && manifestBlurb.trim() !== "") {
            const blurbElement = document.getElementById('customBlurb');
            if (blurbElement) {
                blurbElement.innerHTML = manifestBlurb;
                blurbElement.style.display = 'block';
            }
        }

        function generateLink() {
            const tmdbKey = document.getElementById('tmdbKey').value.trim();
            
            // V√©rifier quel service de d√©bridage est s√©lectionn√©
            const selectedDebrid = document.querySelector('input[name="debridService"]:checked').value;
            let alldebridKey = '';
            let torboxKey = '';
            
            if (selectedDebrid === 'alldebrid') {
                alldebridKey = document.getElementById('alldebridKey').value.trim();
                if (!alldebridKey) {
                    alert("Erreur : Veuillez entrer votre cl√© API AllDebrid.");
                    return;
                }
            } else if (selectedDebrid === 'torbox') {
                torboxKey = document.getElementById('torboxKey').value.trim();
                if (!torboxKey) {
                    alert("Erreur : Veuillez entrer votre cl√© API TorBox.");
                    return;
                }
            }
            
            // qBit Config
            const qbitUrl = document.getElementById('qbitUrl').value.trim();
            const qbitUser = document.getElementById('qbitUser').value.trim();
            const qbitPass = document.getElementById('qbitPass').value.trim();
            const qbitPublicUrl = document.getElementById('qbitPublicUrl').value.trim();
            
            const hasQbit = qbitUrl && qbitPublicUrl;
            
            const sharewoodPasskey = document.getElementById('sharewoodPasskey').value.trim();
            const yggPasskey = document.getElementById('yggPasskey').value.trim();
            
            if (!tmdbKey) {
                alert("Erreur : La cl√© TMDB est obligatoire.");
                return;
            }
            
            if (selectedDebrid === 'none' && !qbittorrentEnabled) {
                alert("Erreur : qBittorrent est d√©sactiv√© sur ce serveur. Vous devez configurer un service de d√©bridage (AllDebrid ou TorBox).");
                return;
            }
            
            if (selectedDebrid === 'none' && !hasQbit) {
                alert("Erreur : Vous devez configurer soit un service de d√©bridage (AllDebrid/TorBox), soit qBittorrent.");
                return;
            }

            const trackers = [];
            document.querySelectorAll('.tracker-item').forEach(item => {
                const url = item.querySelector('.tracker-url').value.trim();
                const token = item.querySelector('.tracker-token').value.trim();
                
                if (url && token) {
                    trackers.push({
                        url: url.replace(/\/$/, ''), 
                        token: token
                    });
                }
            });

            if (trackers.length === 0 && !sharewoodPasskey && !yggPasskey) {
                alert("Attention : Vous devez configurer au moins une source (Tracker UNIT3D, Sharewood ou YGG).");
                return;
            }

            const config = {
                tmdb_key: tmdbKey,
                alldebrid_key: alldebridKey,
                torbox_key: torboxKey,
                trackers: trackers,
                sharewood_passkey: sharewoodPasskey,
                ygg_passkey: yggPasskey,
                qbittorrent: hasQbit ? {
                    host: qbitUrl,
                    username: qbitUser,
                    password: qbitPass,
                    public_url: qbitPublicUrl
                } : null
            };

            const configStr = JSON.stringify(config);
            const configB64 = btoa(configStr);
            
            let baseUrl = window.location.href;
            if (baseUrl.includes('/configure')) {
                baseUrl = baseUrl.split('/configure')[0];
            } else if (baseUrl.includes('/')) {
                 baseUrl = window.location.origin;
            }
            
            baseUrl = baseUrl.replace(/\/$/, '');

            const installUrl = `stremio://${window.location.host}/${configB64}/manifest.json`;
            const httpInstallUrl = `${baseUrl}/${configB64}/manifest.json`;
            const configPageUrl = `${baseUrl}/${configB64}/configure`;

            const linkDiv = document.getElementById('installLink');
            const link = document.getElementById('stremioLink');
            const extraLinks = document.getElementById('extraLinks');
            
            link.href = installUrl;
            linkDiv.style.display = 'block';
            
            extraLinks.innerHTML = `
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ccc;">
                    <p style="margin-bottom: 5px;"><strong>Lien manuel (si le bouton ne marche pas) :</strong></p>
                    <input type="text" value="${httpInstallUrl}" readonly onclick="this.select()" style="font-size: 0.9em; background: #f1f1f1;">
                    
                    <p style="margin-top: 15px; margin-bottom: 5px;"><strong>Lien pour modifier cette configuration plus tard :</strong></p>
                    <input type="text" value="${configPageUrl}" readonly onclick="this.select()" style="font-size: 0.9em; background: #f1f1f1;">
                </div>
            `;
            
            linkDiv.scrollIntoView({behavior: 'smooth'});
        }
    </script>
</body>
</html>
